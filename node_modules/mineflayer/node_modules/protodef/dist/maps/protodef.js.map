{"version":3,"sources":["protodef.js"],"names":[],"mappings":"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","file":"protodef.js","sourcesContent":["var { getFieldInfo, tryCatch } = require('./utils');\nvar reduce = require('lodash.reduce');\n\nfunction isFieldInfo(type) {\n  return typeof type === \"string\"\n    || (Array.isArray(type) && typeof type[0] === \"string\")\n    || type.type;\n}\n\nfunction findArgs(acc, v, k) {\n  if (typeof v === \"string\" && v.charAt(0) === '$')\n    acc.push({ \"path\": k, \"val\": v.substr(1) });\n  else if (Array.isArray(v) || typeof v === \"object\")\n    acc = acc.concat(reduce(v, findArgs, []).map((v) => ({ \"path\": k + \".\" + v.path, \"val\": v.val })));\n  return acc;\n}\n\nfunction setField(path, val, into) {\n  var c = path.split('.').reverse();\n  while (c.length > 1) {\n    into = into[c.pop()];\n  }\n  into[c.pop()] = val;\n}\n\nfunction extendType(functions, defaultTypeArgs) {\n  var json=JSON.stringify(defaultTypeArgs);\n  var argPos = reduce(defaultTypeArgs, findArgs, []);\n  function produceArgs(typeArgs) {\n    var args = JSON.parse(json);\n    argPos.forEach((v) => {\n      setField(v.path, typeArgs[v.val], args);\n    });\n    return args;\n  }\n  return [function read(buffer, offset, typeArgs, context) {\n    return functions[0].call(this, buffer, offset, produceArgs(typeArgs), context);\n  }, function write(value, buffer, offset, typeArgs, context) {\n    return functions[1].call(this, value, buffer, offset, produceArgs(typeArgs), context);\n  }, function sizeOf(value, typeArgs, context) {\n    if (typeof functions[2] === \"function\")\n      return functions[2].call(this, value, produceArgs(typeArgs), context);\n    else\n      return functions[2];\n  }];\n}\n\nclass ProtoDef\n{\n  constructor() {\n    this.types={};\n    this.addDefaultTypes();\n  }\n\n  addDefaultTypes() {\n    this.addTypes(require(\"./datatypes/numeric\"));\n    this.addTypes(require(\"./datatypes/utils\"));\n    this.addTypes(require(\"./datatypes/structures\"));\n    this.addTypes(require(\"./datatypes/conditional\"));\n  }\n\n  addType(name, functions) {\n    if (functions === \"native\")\n      return;\n    if (isFieldInfo(functions)) {\n      var {type,typeArgs} = getFieldInfo(functions);\n      this.types[name] = extendType(this.types[type], typeArgs);\n    }\n    else\n      this.types[name] = functions;\n  }\n\n  addTypes(types) {\n    Object.keys(types).forEach((name) => this.addType(name, types[name]));\n  }\n\n  read(buffer, cursor, _fieldInfo, rootNodes) {\n    let {type,typeArgs} = getFieldInfo(_fieldInfo);\n    var typeFunctions = this.types[type];\n    if(!typeFunctions)\n      throw new Error(\"missing data type: \" + type);\n    return typeFunctions[0].call(this, buffer, cursor, typeArgs, rootNodes);\n  }\n\n  write(value, buffer, offset, _fieldInfo, rootNode) {\n    let {type,typeArgs} = getFieldInfo(_fieldInfo);\n    var typeFunctions = this.types[type];\n    if(!typeFunctions)\n      throw new Error(\"missing data type: \" + type);\n    return typeFunctions[1].call(this, value, buffer, offset, typeArgs, rootNode);\n  }\n\n  sizeOf(value, _fieldInfo, rootNode) {\n    let {type,typeArgs} = getFieldInfo(_fieldInfo);\n    var typeFunctions = this.types[type];\n    if(!typeFunctions) {\n      throw new Error(\"missing data type: \" + type);\n    }\n    if(typeof typeFunctions[2] === 'function') {\n      return typeFunctions[2].call(this, value, typeArgs, rootNode);\n    } else {\n      return typeFunctions[2];\n    }\n  }\n\n  createPacketBuffer(type,packet) {\n    var length=tryCatch(()=> this.sizeOf(packet, type, {}),\n      (e)=> {\n        e.message = `SizeOf error for ${e.field} : ${e.message}`;\n        throw e;\n      });\n    var buffer = new Buffer(length);\n    tryCatch(()=> this.write(packet, buffer, 0, type, {}),\n      (e)=> {\n        e.message = `Write error for ${e.field} : ${e.message}`;\n        throw e;\n      });\n    return buffer;\n  }\n\n  parsePacketBuffer(type,buffer) {\n    var {value,size}=tryCatch(()=> this.read(buffer, 0, type, {}),\n      (e) => {\n        e.message=`Read error for ${e.field} : ${e.message}`;\n        throw e;\n      });\n    return {\n      data: value,\n      metadata:{\n        size:size\n      },\n      buffer:buffer.slice(0,size)\n    };\n  }\n}\n\nmodule.exports = ProtoDef;\n"],"sourceRoot":"/source/"}